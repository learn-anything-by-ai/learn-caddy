# 高级负载均衡配置
localhost:8080 {
    reverse_proxy {
        # 后端服务器配置
        to http://localhost:3001 max_conns 100
        to http://localhost:3002 max_conns 100
        to http://localhost:3003 max_conns 50
        
        # 负载均衡策略 - 最少连接
        lb_policy least_conn
        
        # 高级健康检查
        health_uri /health
        health_interval 10s
        health_timeout 3s
        health_status 200
        health_passes 2
        health_fails 3
        
        # 故障转移配置
        fail_duration 30s
        max_fails 3
        
        # 请求头处理
        header_up Host {upstream_hostport}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
    }
    
    # 响应头
    header {
        Server "Caddy Load Balancer"
        X-Served-By "Backend-{upstream_hostport}"
    }
    
    # 访问日志
    log {
        output file /var/log/caddy/loadbalancer.log
        format json
    }
}
