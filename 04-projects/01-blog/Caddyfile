# 个人博客站点 Caddyfile 配置
# 生产级博客网站配置

# 主域名配置
blog.example.com {
    # 网站根目录
    root * /var/www/blog
    
    # 启用压缩
    encode gzip zstd
    
    # 静态文件缓存
    @static {
        file
        path *.css *.js *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2
    }
    
    header @static {
        Cache-Control "public, max-age=31536000, immutable"
        Vary "Accept-Encoding"
    }
    
    # HTML 文件缓存
    @html {
        file
        path *.html
    }
    
    header @html {
        Cache-Control "public, max-age=3600"
        Vary "Accept-Encoding"
    }
    
    # 安全头设置
    header {
        # 安全头
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
        
        # CSP 内容安全策略
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://www.google-analytics.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com;"
        
        # 移除服务器信息
        -Server
    }
    
    # SEO 友好的 URL 重写
    @clean_urls {
        not path */
        not path *.html
        not path *.css
        not path *.js
        not path *.png
        not path *.jpg
        not path *.jpeg
        not path *.gif
        not path *.ico
        not path *.svg
        not path *.woff
        not path *.woff2
        not path *.xml
        not path *.txt
    }
    
    rewrite @clean_urls {path}.html
    
    # 404 错误处理
    handle_errors {
        @404 {
            expression {http.error.status_code} == 404
        }
        rewrite @404 /404.html
        file_server
    }
    
    # RSS feed 处理
    handle /feed {
        redir /rss.xml permanent
    }
    
    handle /rss {
        redir /rss.xml permanent
    }
    
    # Sitemap 处理
    handle /sitemap {
        redir /sitemap.xml permanent
    }
    
    # 文件服务器
    file_server
    
    # 访问日志
    log {
        output file /var/log/caddy/blog-access.log {
            roll_size 10mb
            roll_keep 5
            roll_keep_for 720h
        }
        format json {
            time_format "2006-01-02T15:04:05Z07:00"
            level_key "level"
            time_key "timestamp"
            message_key "message"
        }
        level INFO
    }
}

# www 重定向
www.blog.example.com {
    redir https://blog.example.com{uri} permanent
}

# 开发环境配置
:8080 {
    root * ./public
    encode gzip
    file_server browse
    
    # 开发时的错误页面显示
    handle_errors {
        respond "开发模式错误: {http.error.status_code} - {http.error.status_text}"
    }
}
